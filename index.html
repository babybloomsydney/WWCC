<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WWCC Manual Check • Baby Bloom Sydney</title>
  <style>
    :root {--primary:#4f46e5;--bg:#f8fafc;--text:#1e293b;--border:#e2e8f0;--hover:#eef2ff;--accent:#10b981;--green:#059669;}
    body {margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);padding:1rem;}
    .container {max-width:900px;margin:0 auto;background:white;border-radius:12px;box-shadow:0 4px 6px -1px rgba(0,0,0,.1);overflow:hidden;}
    header {background:var(--primary);color:white;padding:1.5rem;text-align:center;position:relative;}
    header h1 {margin:0;font-size:1.5rem;font-weight:600;}
    .verify-btn {background:var(--accent);color:white;padding:.5rem 1rem;border-radius:999px;font-size:.875rem;font-weight:600;cursor:pointer;transition:background .2s;position:absolute;right:1.5rem;top:50%;transform:translateY(-50%);}
    .verify-btn:hover {background:#059669;}
    .content {padding:1.5rem;}
    .table-wrapper {max-height:70vh;overflow-y:auto;border:1px solid var(--border);border-radius:8px;overflow-x:auto;}
    table {width:100%;min-width:500px;border-collapse:collapse;font-size:.9375rem;}
    thead {position:sticky;top:0;z-index:10;}
    th {text-align:left;padding:.75rem .5rem;background:#f1f5f9;border-bottom:2px solid var(--border);font-weight:600;color:var(--text);}
    td {padding:.75rem .5rem;border-bottom:1px solid var(--border);cursor:pointer;transition:background .2s;}
    tr:hover td {background:var(--hover);}
    .action-btn {width:40px;height:40px;border-radius:50%;background:var(--accent);color:white;font-size:1.2rem;font-weight:bold;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:background .2s;margin:0 auto;}
    .action-btn:hover {background:#059669;}
    .action-btn.done {background:var(--green);}
    .empty {text-align:center;padding:3rem;color:#64748b;font-style:italic;}
    tr.done td {background:#dcfce7 !important;}
    @media (max-width:640px){
      .verify-btn {position:static;transform:none;margin-top:1rem;display:inline-block;}
      .table-wrapper {max-height:50vh;}
      table {font-size:.875rem;}
      th, td {padding:.5rem .3rem;}
      .action-btn {width:36px;height:36px;font-size:1rem;}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>WWCC Manual Verification</h1>
      <div class="verify-btn" id="verifyBtn">Verify 0 WWCC's</div>
    </header>
    <div class="content">
      <div class="table-wrapper">
        <table id="wwccTable">
          <thead>
            <tr>
              <th>Surname</th>
              <th>DOB</th>
              <th>WWCC</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // ---- Decode packet ----
    const params = new URLSearchParams(location.search);
    const encoded = params.get('data') || '';
    let packet;
    try {
      const decoded = atob(encoded);
      packet = JSON.parse(decoded);
    } catch (e) {
      document.getElementById('tableBody').innerHTML = `<tr><td colspan="4" class="empty">Invalid or missing data.</td></tr>`;
      document.getElementById('verifyBtn').textContent = 'Error';
      console.error(e);
      throw e;
    }

    const firstObj = Array.isArray(packet) ? packet[0] : packet;
    const items = (firstObj && firstObj.items) || [];
    const count = items.length;

    // Update Verify button
    const verifyBtn = document.getElementById('verifyBtn');
    verifyBtn.textContent = count === 0 ? 'No WWCC\'s' : `Verify ${count} WWCC${count > 1 ? '\'s' : ''}`;
    verifyBtn.onclick = () => {
      if (count > 0) {
        window.open('https://wwccemployer.ocg.nsw.gov.au/VerifyEmployee', '_blank');
      }
    };

    const tbody = document.getElementById('tableBody');
    if (count === 0) {
      tbody.innerHTML = `<tr><td colspan="4" class="empty">No data received.</td></tr>`;
    } else {
      items.forEach(row => {
        const tr = document.createElement('tr');

        // Surname
        const td1 = document.createElement('td');
        td1.textContent = row['1'] || '';
        td1.onclick = () => copy(td1.textContent, td1);
        tr.appendChild(td1);

        // DOB (format DD/MM/YYYY)
        const td2 = document.createElement('td');
        const rawDob = row['3'] || '';
        const formattedDob = rawDob ? rawDob.split('-').reverse().join('/') : '';
        td2.textContent = formattedDob;
        td2.onclick = () => copy(formattedDob, td2);
        tr.appendChild(td2);

        // WWCC
        const td3 = document.createElement('td');
        td3.textContent = row['7'] || '';
        td3.onclick = () => copy(td3.textContent, td3);
        tr.appendChild(td3);

        // + / ✓ Button (centered)
        const td otra = document.createElement('td');
        const btn = document.createElement('div');
        btn.className = 'action-btn';
        btn.textContent = '+';
        btn.onclick = (e) => {
          e.stopPropagation();
          tr.classList.toggle('done');
          btn.textContent = tr.classList.contains('done') ? '✓' : '+';
        };
        td4.appendChild(btn);
        tr.appendChild(td4);

        tbody.appendChild(tr);
      });
    }

    // Copy function
    function copy(text, el) {
      navigator.clipboard.writeText(text).then(() => {
        const orig = el.textContent;
        el.textContent = 'Copied!';
        el.style.color = 'green';
        setTimeout(() => { el.textContent = orig; el.style.color = ''; }, 1000);
      }).catch(err => {
        console.error('Copy failed', err);
        alert('Copy failed – select & copy manually.');
      });
    }
  </script>
</body>
</html>
