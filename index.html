<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WWCC Manual Check â€¢ Baby Bloom Sydney</title>
  <style>
    :root {--primary:#4f46e5;--bg:#f8fafc;--text:#1e293b;--border:#e2e8f0;--hover:#eef2ff;--accent:#10b981;--green:#059669;}
    body {margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);overflow:hidden;height:100vh;}
    .main {display:flex;height:100vh;position:relative;}
    .table-section {width:33%;overflow-y:auto;padding:1rem;border-right:1px solid var(--border);background:white;display:flex;flex-direction:column;}
    .portal-section {width:67%;padding:2rem;display:flex;flex-direction:column;justify-content:center;align-items:center;background:#f8fafc;position:relative;}
    .portal-trigger {background:var(--accent);color:white;padding:1rem 2rem;border-radius:8px;font-size:1.1rem;font-weight:600;cursor:pointer;transition:background .2s;}
    .portal-trigger:hover {background:#059669;}
    .portal-tip {text-align:center;margin-top:1rem;color:#64748b;font-size:0.9rem;}
    header {background:var(--primary);color:white;padding:1rem;text-align:center;}
    header h1 {margin:0;font-size:1.5rem;font-weight:600;}
    .count-badge {display:inline-block;background:rgba(255,255,255,.2);padding:.25rem .75rem;border-radius:999px;font-size:.875rem;margin-top:.5rem;}
    table {width:100%;border-collapse:collapse;font-size:.9375rem;flex:1;}
    th {text-align:left;padding:.75rem .5rem;background:#f1f5f9;border-bottom:2px solid var(--border);font-weight:600;color:var(--text);}
    td {padding:.75rem .5rem;border-bottom:1px solid var(--border);cursor:pointer;transition:background .2s;}
    tr:hover td {background:var(--hover);}
    .action-btn {background:var(--accent);color:white;padding:0.35rem 0.75rem;border-radius:6px;font-size:0.8rem;font-weight:500;cursor:pointer;transition:background .2s;margin-right:0.5rem;}
    .action-btn:hover {background:#059669;}
    .copy-all-btn {background:var(--primary);}
    .empty {text-align:center;padding:2rem;color:#64748b;font-style:italic;}
    tr.done td {background:#dcfce7 !important;}
    .modal-overlay {display:none;position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);justify-content:center;align-items:center;z-index:1000;}
    .modal-content {background:white;width:90%;max-width:1000px;height:90%;border-radius:12px;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 10px 30px rgba(0,0,0,.3);}
    .modal-header {background:var(--primary);color:white;padding:1rem;text-align:center;font-weight:600;position:relative;}
    .close {position:absolute;right:1rem;top:1rem;font-size:1.5rem;cursor:pointer;color:white;}
    .modal-body {flex:1;}
    .modal-body iframe {width:100%;height:100%;border:none;}
    @media (max-width:1024px){
      .main {flex-direction:column;}
      .table-section {width:100%;height:50vh;}
      .portal-section {width:100%;height:50vh;padding:1rem;}
    }
  </style>
</head>
<body>
  <div class="main">
    <div class="table-section">
      <header>
        <h1>WWCC Manual Verification</h1>
        <div class="count-badge" id="countBadge">Loadingâ€¦</div>
      </header>
      <table id="wwccTable">
        <thead>
          <tr>
            <th>Surname</th>
            <th>DOB</th>
            <th>WWCC</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
    <div class="portal-section" id="portalSection">
      <div class="portal-trigger" onclick="openPortalModal()">
        Open Portal in Modal
      </div>
      <div class="portal-tip">
        ðŸ’¡ Click row buttons â†’ Copy â†’ Paste into portal. Click "Added" when done.
      </div>
    </div>
  </div>

  <!-- Modal Overlay (in right section) -->
  <div id="portalModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <span>NSW Employer WWCC Portal</span>
        <span class="close" onclick="closePortalModal()">Ã—</span>
      </div>
      <div class="modal-body">
        <iframe src="https://wwccemployer.ocg.nsw.gov.au/VerifyEmployee"></iframe>
      </div>
    </div>
  </div>

  <script>
    // Decode packet
    const params = new URLSearchParams(location.search);
    const encoded = params.get('data') || '';
    let packet;
    try {
      const decoded = atob(encoded);
      packet = JSON.parse(decoded);
    } catch (e) {
      document.getElementById('tableBody').innerHTML = `<tr><td colspan="4" class="empty">Invalid data.</td></tr>`;
      document.getElementById('countBadge').textContent = 'Error';
      console.error(e);
      throw e;
    }

    const firstObj = Array.isArray(packet) ? packet[0] : packet;
    const items = (firstObj && firstObj.items) || [];
    const count = items.length;
    document.getElementById('countBadge').textContent = count === 0 ? 'No WWCC\'s' : `${count} WWCC${count > 1 ? '\'s' : ''}`;

    const tbody = document.getElementById('tableBody');
    if (count === 0) {
      tbody.innerHTML = `<tr><td colspan="4" class="empty">No data received.</td></tr>`;
    } else {
      items.forEach(row => {
        const tr = document.createElement('tr');

        // Surname
        const td1 = document.createElement('td');
        td1.textContent = row['1'] || '';
        td1.onclick = () => copy(td1.textContent, td1);
        tr.appendChild(td1);

        // DOB
        const td2 = document.createElement('td');
        td2.textContent = row['3'] || '';
        td2.onclick = () => copy(td2.textContent, td2);
        tr.appendChild(td2);

        // WWCC
        const td3 = document.createElement('td');
        td3.textContent = row['7'] || '';
        td3.onclick = () => copy(td3.textContent, td3);
        tr.appendChild(td3);

        // Actions
        const td4 = document.createElement('td');
        // Copy All
        const copyAllBtn = document.createElement('div');
        copyAllBtn.className = 'action-btn copy-all-btn';
        copyAllBtn.textContent = 'Copy All';
        copyAllBtn.onclick = (e) => {
          e.stopPropagation();
          const allText = `Surname: ${row['1'] || ''} | DOB: ${row['3'] || ''} | WWCC: ${row['7'] || ''}`;
          copy(allText, copyAllBtn);
        };
        td4.appendChild(copyAllBtn);
        // Added
        const addedBtn = document.createElement('div');
        addedBtn.className = 'action-btn';
        addedBtn.textContent = 'Added';
        addedBtn.onclick = (e) => {
          e.stopPropagation();
          tr.classList.toggle('done');
        };
        td4.appendChild(addedBtn);
        tr.appendChild(td4);

        tbody.appendChild(tr);
      });
    }

    // Copy
    function copy(text, el) {
      navigator.clipboard.writeText(text).then(() => {
        const orig = el.textContent;
        el.textContent = 'Copied!';
        el.style.color = 'green';
        setTimeout(() => { el.textContent = orig; el.style.color = ''; }, 1000);
      });
    }

    // Modal
    function openPortalModal() {
      document.getElementById('portalModal').style.display = 'flex';
    }
    function closePortalModal() {
      document.getElementById('portalModal').style.display = 'none';
    }
    document.getElementById('portalModal').addEventListener('click', (e) => {
      if (e.target.id === 'portalModal') closePortalModal();
    });
  </script>
</body>
</html>
