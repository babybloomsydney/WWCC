<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WWCC Manual Check • Baby Bloom Sydney</title>
  <style>
    :root {--primary:#4f46e5;--bg:#f8fafc;--text:#1e293b;--border:#e2e8f0;--hover:#eef2ff;--accent:#10b981;--green:#059669;}
    body {margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);overflow:hidden;}
    .main {display:flex;height:100vh;}
    .table-section {width:33%;overflow-y:auto;padding:1rem;border-right:1px solid var(--border);background:white;}
    .portal-section {width:67%;height:100%;}
    .portal-section iframe {width:100%;height:100%;border:none;}
    header {background:var(--primary);color:white;padding:1rem;text-align:center;}
    header h1 {margin:0;font-size:1.5rem;font-weight:600;}
    .count-badge {display:inline-block;background:rgba(255,255,255,.2);padding:.25rem .75rem;border-radius:999px;font-size:.875rem;margin-top:.5rem;}
    table {width:100%;border-collapse:collapse;font-size:.9375rem;}
    th {text-align:left;padding:.75rem .5rem;background:#f1f5f9;border-bottom:2px solid var(--border);font-weight:600;color:var(--text);}
    td {padding:.75rem .5rem;border-bottom:1px solid var(--border);cursor:pointer;transition:background .2s;}
    tr:hover td {background:var(--hover);}
    .action-btn {background:var(--accent);color:white;padding:0.35rem 0.75rem;border-radius:6px;font-size:0.8rem;font-weight:500;cursor:pointer;transition:background .2s;}
    .action-btn:hover {background:#059669;}
    .empty {text-align:center;padding:2rem;color:#64748b;font-style:italic;}
    tr.done td {background:#dcfce7 !important;}
    @media (max-width:1024px){
      .main {flex-direction:column;}
      .table-section {width:100%;height:50vh;}
      .portal-section {width:100%;height:50vh;}
    }
  </style>
</head>
<body>
  <div class="main">
    <div class="table-section">
      <header>
        <h1>WWCC Manual Verification</h1>
        <div class="count-badge" id="countBadge">Loading…</div>
      </header>
      <table id="wwccTable">
        <thead>
          <tr>
            <th>Surname</th>
            <th>DOB</th>
            <th>WWCC</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
    <div class="portal-section">
      <iframe src="https://wwccemployer.ocg.nsw.gov.au/VerifyEmployee"></iframe>
    </div>
  </div>

  <script>
    // ---- Decode packet ----
    const params = new URLSearchParams(location.search);
    const encoded = params.get('data') || '';
    let packet;
    try {
      const decoded = atob(encoded);
      packet = JSON.parse(decoded);
    } catch (e) {
      document.getElementById('tableBody').innerHTML = `<tr><td colspan="4" class="empty">Invalid data.</td></tr>`;
      document.getElementById('countBadge').textContent = 'Error';
      console.error(e);
      throw e;
    }

    const firstObj = Array.isArray(packet) ? packet[0] : packet;
    const items = (firstObj && firstObj.items) || [];
    const count = items.length;
    document.getElementById('countBadge').textContent = count === 0 ? 'No WWCC\'s' : `${count} WWCC${count > 1 ? '\'s' : ''}`;

    const tbody = document.getElementById('tableBody');
    if (count === 0) {
      tbody.innerHTML = `<tr><td colspan="4" class="empty">No data received.</td></tr>`;
    } else {
      items.forEach(row => {
        const tr = document.createElement('tr');

        // Surname
        const td1 = document.createElement('td');
        td1.textContent = row['1'] || '';
        td1.onclick = () => copy(td1.textContent, td1);
        tr.appendChild(td1);

        // DOB
        const td2 = document.createElement('td');
        td2.textContent = row['3'] || '';
        td2.onclick = () => copy(td2.textContent, td2);
        tr.appendChild(td2);

        // WWCC
        const td3 = document.createElement('td');
        td3.textContent = row['7'] || '';
        td3.onclick = () => copy(td3.textContent, td3);
        tr.appendChild(td3);

        // Added Button
        const td4 = document.createElement('td');
        const btn = document.createElement('div');
        btn.className = 'action-btn';
        btn.textContent = 'Added';
        btn.onclick = (e) => {
          e.stopPropagation();
          tr.classList.toggle('done');
        };
        td4.appendChild(btn);
        tr.appendChild(td4);

        tbody.appendChild(tr);
      });
    }

    // Copy function
    function copy(text, el) {
      navigator.clipboard.writeText(text).then(() => {
        const orig = el.textContent;
        el.textContent = 'Copied!';
        el.style.color = 'green';
        setTimeout(() => { el.textContent = orig; el.style.color = ''; }, 1000);
      }).catch(err => {
        console.error('Copy failed', err);
        alert('Copy failed – select & copy manually.');
      });
    }
  </script>
</body>
</html>
